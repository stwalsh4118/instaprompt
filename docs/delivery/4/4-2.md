# 4-2 Integrate Editor with Prompt CRUD

[Back to task list](./tasks.md)

## Description

Modify the Add Prompt and Edit Prompt commands to open the webview markdown editor instead of using input boxes. Wire up save/cancel handlers to persist changes.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-12-25 12:00:00 | Created | N/A | Proposed | Task file created | User |
| 2025-01-08 21:00:00 | Status Update | Proposed | InProgress | Started implementation | AI Agent |
| 2025-01-08 21:30:00 | Status Update | InProgress | Review | Implementation complete, ready for review | AI Agent |
| 2025-01-08 22:00:00 | Status Update | Review | Done | Task completed and verified | User |

## Requirements

1. Modify `handleAddPrompt()` to open webview editor instead of input boxes
2. Modify `handleEditPrompt()` to open webview editor with existing content
3. Wire up save handler to call `addPrompt()` or `updatePrompt()`
4. Wire up cancel handler to close editor without saving
5. Handle prompt name input (before or after content editing)
6. Show success/error notifications

## Implementation Plan

1. **Update `handleAddPrompt()` in `extension.ts`**:
   - First prompt for name (keep existing input box)
   - Then open webview editor with empty content
   - On save: call `addPrompt(name, content)`
   - Show success notification

2. **Update `handleEditPrompt()` in `extension.ts`**:
   - Select prompt from list (keep existing quick pick)
   - Open webview editor with existing content pre-filled
   - On save: call `updatePrompt(id, { content, updatedAt })`
   - Show success notification

3. **Create editor wrapper functions**:
   - `openEditorForNewPrompt(name: string): Promise<string | undefined>`
   - `openEditorForEdit(prompt: Prompt): Promise<string | undefined>`
   - Both return content string if saved, undefined if cancelled

4. **Handle errors**:
   - Catch save errors and show error notification
   - Handle webview disposal errors gracefully

5. **Optional: Name editing in webview**:
   - Consider adding name field to webview for edit mode
   - Or keep name editing separate (simpler for now)

## Verification

- [x] Add Prompt opens webview editor after name input
- [x] Edit Prompt opens webview editor with existing content
- [x] Saving new prompt creates prompt successfully
- [x] Saving edited prompt updates prompt successfully
- [x] Cancelling closes editor without saving
- [x] Error notifications shown on save failures

## Test Plan

- Add new prompt: enter name, edit in webview, save, verify prompt created
- Edit existing prompt: select prompt, edit in webview, save, verify prompt updated
- Cancel editing: open editor, make changes, cancel, verify no changes saved
- Error handling: simulate save failure, verify error notification

## Files Modified

- `src/extension.ts` (modified)
  - Moved `handleAddPrompt()` and `handleEditPrompt()` inside `activate()` as closures to access context
  - Updated `handleAddPrompt()` to open webview editor after name input
  - Updated `handleEditPrompt()` to use webview editor for content editing (name-only editing still uses input box)
  - Added import for `openMarkdownEditor`
- `src/markdownEditor.ts` (modified)
  - Simplified editor implementation to use textarea instead of CodeMirror 6 (due to CDN dependency issues)
  - Implemented live markdown preview using marked.js
  - Added keyboard shortcuts (Ctrl+S to save, Escape to cancel, Tab for indentation)
  - Fixed preview text alignment issues
- `package.json` (modified)
  - Changed `main` entry from `./dist/extension.js` to `./out/extension.js` for development
- `docs/api-specs/extension/commands-api.md` (modified)
  - Updated command flow documentation to reflect webview editor usage
- `docs/api-specs/ui/markdown-editor-api.md` (modified)
  - Updated implementation details to reflect textarea-based editor


